#!/usr/bin/env BQN

âŸ¨
  Depths
  PrettyPrint
âŸ©â‡

Depths â† {
  pâ†ğ•© # input parent vec
  StepUpâ†{ ğ•Š dâ€¿prevâ€¿cur:
    q â† cur âŠ p
    (d+curâ‰ q)â€¿curâ€¿q
  }
  âŠ‘ StepUpâ€¢_while_(â‰¢Â´1âŠ¸â†“) (ğ•©â‰ âŠ¸â¥Š0)â€¿âŸ¨âŸ©â€¿(â†•â‰ ğ•©)
}

PrettyPrint â† { labels ğ•Š p:
  # labels: vector of character matrices giving labels for each node
  # p: parent vector
  connectorsâ†"â”€â”Œâ”¬â”â”‚â”´â”œâ”¼â”¤â”‚" # box-drawing characters (vertical)
  spacesâ†1 # num spaces to pad between subtrees (vertical)
  dâ†Depths p
  maxDepthâ†âŒˆÂ´d
  resultsâ†labels
  # TODO check for maxDepth=0

  DoFamilyâ†{
    # ğ•¨: parent node
    # ğ•©: rendered results of children

    # widths of each rendered child
    widthsâ†(1âŠ‘â‰¢)Â¨ğ•©
    # eventual width of the rendered tree 
    widthâ†spaces-Ëœ+Â´spaces+widths                #  wwwwwww
    # centres of each rendered sub-tree
    centresâ†(+Â´0âˆ¾Â¯1â†“spaces+widths)+Â¯1+âŒˆwidthsÃ·2                                       #  âˆ˜ssâˆ˜ssâˆ˜
    # header to be decorated
    resultâ†widthâ¥Š' '                                                                  # '       '
    # add horizontal bar
    result (âŠ‘connectors)Â¨âŒ¾(((âŠ¢ âŠ¢âˆ˜/Ëœ ((Â¯1âŠ‘centres)>âŠ¢) âˆ§ (âŠ‘centres) < âŠ¢) â†•width)âŠ¸âŠ)â†©    # ' â”€â”€â”€â”€â”€ '
    # left end of bar
    result (1âŠ‘connectors)Â¨âŒ¾((âŠ‘centres)âŠ¸âŠ)â†©                                            # 'â”Œâ”€â”€â”€â”€â”€ '
    # right end of bar
    result (3âŠ‘connectors)Â¨âŒ¾((Â¯1âŠ‘centres)âŠ¸âŠ)â†©                                          # 'â”Œâ”€â”€â”€â”€â”€â”'
    # connectors to intermediate children
    result (2âŠ‘connectors)Â¨âŒ¾((Â¯1â†“1â†“centres)âŠ¸âŠ)â†©                                        # 'â”Œâ”€â”€â”¬â”€â”€â”'
    # if there's only one child, just make it a lone upstrike
    result (4âŠ‘connectors)Â¨âŒ¾(((1=â‰ centres)â¥ŠâŠ‘centres)âŠ¸âŠ)â†©
    # index of the centre of the rendered tree
    centreâ†Â¯1+âŒˆwidthÃ·2
    # connector to the parent                                                         #     âˆ˜
    result (((Â¯5â†“connectors)âŠâŠ¢)âŠ5â†“connectorsË™)âŒ¾(centreâŠ¸âŠ)â†©                            # 'â”Œâ”€â”€â”¼â”€â”€â”'
    # pad labels, join under header
    result âˆ¾â†© (-spaces) â†“â‰2 âŠ‘ âˆ¾â‰1 / âˆ¾â‰1âˆ˜(spacesâ¥Š' ')â‰2Â¨ ğ•© â†‘Â¨Ëœ âŒˆÂ´â‰ Â¨ğ•©
    # parent's label
    parentResultâ†ğ•¨âŠ‘results
    # width of the parent's label
    parentWidthâ†1âŠ‘â‰¢parentResult
    # centre of the parent's label
    parentCentreâ†Â¯1+âŒˆparentWidthÃ·2
    # pad and recentre text so far if it's less wide
    result ((centre-parentCentre) âŒ½ parentWidth â†‘â‰1 âŠ¢)âŸ(width<parentWidth)â†©
    # pad and recentre parent label if it's less wide
    parentResult ((parentCentre-centre) âŒ½ width â†‘â‰1 âŠ¢)âŸ(width>parentWidth)â†©
    # add parent label
    result â†© result âˆ¾ parentResult
    # record the result
    results (âŠ‘result)âŒ¾(ğ•¨âŠ¸âŠ)â†©
  }
  # Render and record all nodes
  # whose children have depth ğ•©
  DoLayerâ†{
    # ğ•¨: depth at which to handle nodes
    iâ†/d=ğ•©
    # TODO is (â·âˆ˜âŠ£ FÂ¨ âŠâŠ¸âŠ”) the best way to
    # emulate APL's key operator for function F?
    # It seems inefficient due to multiple deduplication
    # passes.
    Â·â†p (â·âˆ˜âŠ£ DoFamilyÂ¨ âŠâŠ¸âŠ”)â—‹(iâŠ¸âŠ) results
  }
  Â·â†DoLayerÂ¨âŒ½1+â†•maxDepth
  results/Ëœp=â†•â‰ p
}

# vertical
PPVâ†{
  ğ•¨â†'âˆ˜'
  ((â‰¢ğ•©) â¥Š â‰âˆ˜âªâˆ˜â•Â¨ ğ•¨) PrettyPrint ğ•©
}

# horizontal
# TODO
#PPHâ†{
#  âºâ†'âˆ˜'
#  â‰Â¨((â‰¢âµ)â´  âªâ¤â•Â¨'âˆ˜'@(0=â‰¢Â¨)âº)('â”‚â”Œâ”œâ””â”€â”¤â”¬â”¼â”´â”€'_PrettyPrint_ 0)âµ
#}

